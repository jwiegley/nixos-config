groups:
  - name: email_service_alerts
    interval: 60s
    rules:
      # Dovecot IMAP Server Alerts
      - alert: DovecotDown
        expr: up{job="dovecot"} == 0
        for: 2m
        labels:
          severity: critical
          category: email
          service: dovecot
        annotations:
          summary: "Dovecot IMAP server is down"
          description: "Dovecot IMAP server has been unreachable for more than 2 minutes. Email access is unavailable."

      - alert: DovecotHighConnectionCount
        expr: dovecot_up_connections > 100
        for: 5m
        labels:
          severity: warning
          category: email
          service: dovecot
        annotations:
          summary: "Dovecot has high connection count"
          description: "Dovecot has {{ $value }} active connections (threshold: 100). May indicate connection leak or attack."

      - alert: DovecotAuthenticationFailures
        expr: rate(dovecot_auth_failures_total[5m]) > 5
        for: 5m
        labels:
          severity: warning
          category: email
          service: dovecot
        annotations:
          summary: "High Dovecot authentication failure rate"
          description: "Dovecot is experiencing {{ $value | humanize }} authentication failures per second over the last 5 minutes. Possible brute force attack."

      # Postfix Mail Server Alerts
      - alert: PostfixDown
        expr: up{job="postfix"} == 0
        for: 2m
        labels:
          severity: critical
          category: email
          service: postfix
        annotations:
          summary: "Postfix mail server is down"
          description: "Postfix mail server exporter has been unreachable for more than 2 minutes. Mail delivery may be affected."

      - alert: PostfixMailQueueHigh
        expr: postfix_queue_size > 100
        for: 10m
        labels:
          severity: warning
          category: email
          service: postfix
        annotations:
          summary: "Postfix mail queue is growing"
          description: "Postfix has {{ $value }} messages in queue (threshold: 100). Mail delivery may be delayed."

      - alert: PostfixMailQueueCritical
        expr: postfix_queue_size > 500
        for: 5m
        labels:
          severity: critical
          category: email
          service: postfix
        annotations:
          summary: "Postfix mail queue is critically high"
          description: "Postfix has {{ $value }} messages in queue (threshold: 500). Immediate attention required."

      - alert: PostfixBouncesHigh
        expr: rate(postfix_bounces_total[15m]) > 0.1
        for: 10m
        labels:
          severity: warning
          category: email
          service: postfix
        annotations:
          summary: "High email bounce rate detected"
          description: "Postfix is experiencing {{ $value | humanizePercentage }} bounce rate over the last 15 minutes."

      - alert: PostfixDeferralsHigh
        expr: rate(postfix_deferrals_total[15m]) > 0.2
        for: 10m
        labels:
          severity: warning
          category: email
          service: postfix
        annotations:
          summary: "High email deferral rate detected"
          description: "Postfix is deferring {{ $value | humanizePercentage }} of outbound messages. Check connectivity to remote servers."

      - alert: PostfixRejectsHigh
        expr: rate(postfix_rejects_total[15m]) > 1
        for: 10m
        labels:
          severity: warning
          category: email
          service: postfix
        annotations:
          summary: "High email rejection rate"
          description: "Postfix is rejecting {{ $value }} messages per second. Possible spam attack or misconfiguration."

      # Rspamd Spam Filter Alerts
      - alert: RspamdServiceDown
        expr: |
          systemd_unit_state{
            name="rspamd.service",
            state="active",
            type="service"
          } == 0
        for: 2m
        labels:
          severity: critical
          category: email
          service: rspamd
        annotations:
          summary: "Rspamd spam filter service is down"
          description: "Rspamd service is not active. Spam filtering is unavailable."

      - alert: RspamdServiceFailed
        expr: |
          systemd_unit_state{
            name="rspamd.service",
            state="failed",
            type="service"
          } == 1
        for: 1m
        labels:
          severity: critical
          category: email
          service: rspamd
        annotations:
          summary: "Rspamd service has failed"
          description: "Rspamd service is in failed state. Check logs for errors."

      # Dovecot Message/Byte Delivery Metrics
      - alert: DovecotNoRecentActivity
        expr: |
          (time() - dovecot_user_last_update{user!="root"}) > 86400
        for: 30m
        labels:
          severity: info
          category: email
          service: dovecot
        annotations:
          summary: "Dovecot user {{ $labels.user }} has no recent activity"
          description: "User {{ $labels.user }} has had no IMAP activity for more than 24 hours. Last activity: {{ $value | humanizeDuration }} ago."

      - alert: DovecotServiceFailed
        expr: |
          systemd_unit_state{
            name="dovecot2.service",
            state="failed",
            type="service"
          } == 1
        for: 1m
        labels:
          severity: critical
          category: email
          service: dovecot
        annotations:
          summary: "Dovecot IMAP service has failed"
          description: "Dovecot service is in failed state. Check logs: journalctl -u dovecot2 -n 50"

      - alert: DovecotServiceInactive
        expr: |
          systemd_unit_state{
            name="dovecot2.service",
            state="active",
            type="service"
          } == 0
        for: 2m
        labels:
          severity: critical
          category: email
          service: dovecot
        annotations:
          summary: "Dovecot IMAP service is not active"
          description: "Dovecot service is not running. Email retrieval is unavailable."

      # Postfix Message/Byte Delivery Metrics
      - alert: PostfixNoMessagesProcessed
        expr: |
          rate(postfix_cleanup_messages_processed_total[30m]) == 0
          and
          (time() - (postfix_cleanup_messages_processed_total > 0)) < 86400
        for: 1h
        labels:
          severity: warning
          category: email
          service: postfix
        annotations:
          summary: "Postfix has not processed any messages recently"
          description: "Postfix has not processed any messages in the last 30 minutes. This may indicate a service issue or lack of outbound mail."

      - alert: PostfixHighMessageVolume
        expr: |
          rate(postfix_cleanup_messages_processed_total[5m]) > 10
        for: 15m
        labels:
          severity: info
          category: email
          service: postfix
        annotations:
          summary: "Postfix is processing high message volume"
          description: "Postfix is processing {{ $value | humanize }} messages per second. This may be normal bulk sending or potential spam."

      - alert: PostfixMessageProcessingStalled
        expr: |
          rate(postfix_qmgr_messages_removed_total[15m]) == 0
          and
          postfix_showq_message_age_seconds_count > 0
        for: 30m
        labels:
          severity: critical
          category: email
          service: postfix
        annotations:
          summary: "Postfix message processing has stalled"
          description: "Postfix has {{ $value }} messages in queue but is not delivering them. Check service health and network connectivity."

      - alert: PostfixServiceFailed
        expr: |
          systemd_unit_state{
            name="postfix.service",
            state="failed",
            type="service"
          } == 1
        for: 1m
        labels:
          severity: critical
          category: email
          service: postfix
        annotations:
          summary: "Postfix mail service has failed"
          description: "Postfix service is in failed state. Check logs: journalctl -u postfix -n 50"

      - alert: PostfixServiceInactive
        expr: |
          systemd_unit_state{
            name="postfix.service",
            state="active",
            type="service"
          } == 0
        for: 2m
        labels:
          severity: critical
          category: email
          service: postfix
        annotations:
          summary: "Postfix mail service is not active"
          description: "Postfix service is not running. Mail delivery is unavailable."

      # Combined Email System Health
      - alert: EmailSystemDegraded
        expr: |
          (up{job="dovecot"} == 0 or up{job="postfix"} == 0)
        for: 5m
        labels:
          severity: critical
          category: email
          service: email-system
        annotations:
          summary: "Email system is degraded"
          description: "One or more core email services (Dovecot, Postfix) are down. Email functionality is impaired."

      - alert: EmailDeliveryLatencyHigh
        expr: |
          histogram_quantile(0.95, rate(postfix_qmgr_messages_inserted_size_bytes_bucket[5m])) > 1000000
        for: 10m
        labels:
          severity: warning
          category: email
          service: postfix
        annotations:
          summary: "Email delivery latency is high"
          description: "95th percentile message size is {{ $value | humanize1024 }} bytes, indicating potential large message backlog or slow processing."
