groups:
  - name: certificates
    interval: 60s
    rules:
      # Alert for certificate expiration
      - alert: CertificateExpiringSoon
        expr: (x509_cert_expiry - time()) / 86400 < 30
        for: 1h
        labels:
          severity: warning
          component: certificates
        annotations:
          summary: "Certificate expiring soon for {{ $labels.subject_CN }}"
          description: "Certificate {{ $labels.subject_CN }} will expire in {{ $value }} days"

      # Alert for certificate already expired
      - alert: CertificateExpired
        expr: x509_cert_expiry - time() <= 0
        for: 1m
        labels:
          severity: critical
          component: certificates
        annotations:
          summary: "Certificate expired for {{ $labels.subject_CN }}"
          description: "Certificate {{ $labels.subject_CN }} has expired"

      # Alert for Step-CA service down
      - alert: StepCADown
        expr: systemd_unit_state{name="step-ca.service",state="active"} != 1
        for: 5m
        labels:
          severity: critical
          component: certificates
        annotations:
          summary: "Step-CA service is down"
          description: "Step-CA certificate authority service has been down for more than 5 minutes"