# Nginx to Caddy Migration - Product Requirements Document

**Version:** 1.0
**Date:** 2025-10-31
**Status:** Ready for Review
**Author:** Claude Code (AI Assistant)

---

## Executive Summary

This document outlines the complete migration strategy for replacing nginx with Caddy as the reverse proxy server on the vulcan NixOS system. The migration will convert 23 nginx virtual hosts to Caddy, implement automatic certificate management via Caddy's internal CA, and eliminate manual certificate renewal infrastructure.

**Key Benefits:**
- **Automatic HTTPS:** Caddy handles certificate issuance and renewal automatically
- **Simplified Configuration:** Cleaner, more maintainable reverse proxy configuration
- **Zero Certificate Management:** No manual scripts or renewal timers needed
- **Modern Protocol Support:** Built-in HTTP/2, HTTP/3 (QUIC) support
- **Better WebSocket Handling:** Native WebSocket proxy support without special configuration

**Timeline:** Estimated 4-6 hours for complete migration (can be done in stages)

**Risk Level:** Medium - requires careful testing of each service, especially Nagios (CGI/PHP)

---

## Table of Contents

1. [Current State Analysis](#current-state-analysis)
2. [Research Findings](#research-findings)
3. [Architecture Design](#architecture-design)
4. [Implementation Plan](#implementation-plan)
5. [Testing Strategy](#testing-strategy)
6. [Rollback Plan](#rollback-plan)
7. [Migration Phases](#migration-phases)
8. [Service Conversion Reference](#service-conversion-reference)

---

## Current State Analysis

### Nginx Infrastructure

**Services Identified:** 23 nginx virtualHosts

**Main Domains:**
1. `vulcan.lan` → redirects to `glance.vulcan.lan`
2. HTTP→HTTPS redirect (serverName = "_")

**Service Domains (*.vulcan.lan):**
3. `budget.vulcan.lan` → BudgetBoard (quadlet container)
4. `changes.vulcan.lan` → ChangeDetection (quadlet container)
5. `loki.vulcan.lan` → Loki log aggregation
6. `cockpit.vulcan.lan` → Cockpit web console
7. `promtail.vulcan.lan` → Promtail log collector
8. `mrtg.vulcan.lan` → MRTG performance graphs
9. `alertmanager.vulcan.lan` → Alertmanager
10. `jellyfin.vulcan.lan` → Jellyfin media server
11. `dns.vulcan.lan` → Technitium DNS
12. `nagios.vulcan.lan` → Nagios (COMPLEX: CGI, PHP-FPM, auth)
13. `nextcloud.vulcan.lan` → Nextcloud
14. `hass.vulcan.lan` → Home Assistant (websockets)
15. `llama-swap.vulcan.lan` → LLama Swap
16. `prometheus.vulcan.lan` → Prometheus
17. `grafana.vulcan.lan` → Grafana
18. `victoriametrics.vulcan.lan` → VictoriaMetrics
19. `postgres.vulcan.lan` → PostgreSQL
20. `nodered.vulcan.lan` → Node-RED
21. `glance.vulcan.lan` → Glance dashboard

**External Domains:**
22. `home.newartisans.com` → Secure nginx container

**Internal Monitoring:**
23. `localhost` (nginx-exporter)

### Certificate Management

**Current Approach:**
- SSL certificates stored in `/var/lib/nginx-certs/`
- Generated by systemd oneshot services before nginx starts
- Manual renewal via shell scripts:
  - `/etc/nixos/certs/renew-nginx-certs.sh`
  - `/etc/nixos/certs/dovecot-cert-renew.sh`
  - `/etc/nixos/certs/postgresql-cert-renew.sh`
  - `/etc/nixos/certs/postfix-cert-renew.sh`
- Renewal timers: `nginx-cert-renewal.timer`, etc.

**Step-CA Status:**
- Running on `127.0.0.1:8443`
- **NO ACME provisioner configured** (`provisioners = []` in ca.json)
- Current mode: Manual certificate issuance only via `step ca certificate` command
- Cannot be used for automatic ACME-based certificate issuance

### Nginx Patterns Observed

**Common Pattern:**
```nix
services.nginx.virtualHosts."service.vulcan.lan" = {
  forceSSL = true;
  sslCertificate = "/var/lib/nginx-certs/service.vulcan.lan.crt";
  sslCertificateKey = "/var/lib/nginx-certs/service.vulcan.lan.key";
  locations."/" = {
    proxyPass = "http://localhost:PORT";
  };
};
```

**Advanced Patterns:**
- **Upstreams with retry logic:** Home Assistant, Grafana (prevent 502 during restarts)
- **WebSocket support:** Home Assistant (via `proxyWebsockets = true`)
- **FastCGI/CGI:** Nagios (fcgiwrap for CGI scripts, PHP-FPM for PHP)
- **Basic Authentication:** Nagios (htpasswd file)
- **Custom headers:** Nagios (AUTH_USER, REMOTE_USER for CGI)

### Complex Service: Nagios

**Configuration Complexity:**
- Basic auth via htpasswd file: `/var/lib/nagios/htpasswd`
- CGI scripts via fcgiwrap Unix socket: `/run/fcgiwrap-nagios.sock`
- PHP files via PHP-FPM pool: `/run/phpfpm/nagios.sock`
- Special FastCGI parameters: `AUTH_USER`, `REMOTE_USER`, `NAGIOS_CGI_CONFIG`
- Multiple location blocks with regex matching
- Static file serving from `${pkgs.nagios}/share`

**This is the most critical service to test thoroughly.**

---

## Research Findings

### Caddy Overview

Caddy is a modern web server with automatic HTTPS by default. Key features:
- **Automatic HTTPS:** Built-in certificate management via ACME or internal CA
- **Zero Configuration TLS:** Just declare a domain, get automatic certificates
- **Modern Protocols:** HTTP/2, HTTP/3 (QUIC) built-in
- **Simpler Syntax:** Caddyfile is more intuitive than nginx config
- **WebSocket Native:** No special configuration needed for WebSocket proxying

### Caddy + Certificate Authority Options

**Option 1: Caddy with Step-CA ACME (Rejected)**
- Requires Step-CA to have ACME provisioner configured
- Current Step-CA has `provisioners = []` - no ACME support
- Would require major Step-CA reconfiguration
- Added complexity for uncertain benefit

**Option 2: Caddy with Existing Step-CA Certificates (SELECTED)**
- Caddy configured to use existing Step-CA root and intermediate certificates
- Caddy will sign certificates using Step-CA intermediate CA
- Root CA: `/var/lib/step-ca-state/certs/root_ca.crt`
- Intermediate CA: `/var/lib/step-ca-state/certs/intermediate_ca.crt`
- Fully automatic certificate issuance and renewal via Caddy PKI module
- Zero configuration per site (just `tls internal` directive)
- **User requirement:** "Caddy should use my root certificate located in /var/lib/step-ca-state/certs/root_ca.crt"

**Decision Rationale:**
1. Maintains existing Step-CA trust chain
2. Clients already trusting Step-CA root will automatically trust Caddy-issued certificates
3. No need to distribute new root CA to clients
4. Unified certificate infrastructure under Step-CA
5. Caddy handles automatic issuance and renewal using Step-CA certificates

### NixOS Caddy Module

**Available Options:**
- `services.caddy.enable`
- `services.caddy.adapter` (caddyfile, json)
- `services.caddy.globalConfig` (global options block)
- `services.caddy.virtualHosts` (virtualhost declarations)
- `services.caddy.extraConfig` (additional Caddyfile config)

**Configuration Pattern:**
```nix
services.caddy = {
  enable = true;

  globalConfig = ''
    # Global options here
  '';

  virtualHosts = {
    "domain.com" = {
      extraConfig = ''
        tls internal
        reverse_proxy localhost:8080
      '';
    };
  };
};
```

---

## Architecture Design

### Module Organization Strategy

**Approach:** Distributed Configuration (maintains existing structure)

**Rationale:**
- Keep service-specific configuration in existing service modules
- Each service file manages its own Caddy virtualHost
- Easier maintenance and code review
- Follows established pattern in this codebase

**Base Configuration Location:** `/etc/nixos/modules/services/web.nix`

### Base Caddy Service Configuration

**File:** `/etc/nixos/modules/services/web.nix`

```nix
{ config, lib, pkgs, ... }:

{
  services.caddy = {
    enable = true;

    # Global Caddy options - configure PKI to use existing Step-CA certificates
    globalConfig = ''
      {
        # Configure Caddy to use existing Step-CA certificates
        pki {
          ca local {
            name "Vulcan Certificate Authority"
            root {
              cert /var/lib/step-ca-state/certs/root_ca.crt
              key /var/lib/step-ca-state/secrets/root_ca_key
            }
            intermediate {
              cert /var/lib/step-ca-state/certs/intermediate_ca.crt
              key /var/lib/step-ca-state/secrets/intermediate_ca_key
            }
          }
        }

        # Disable automatic redirects (handle per-site)
        auto_https disable_redirects

        # Enable HTTP/1.1, HTTP/2, HTTP/3
        servers {
          protocols h1 h2 h3
        }
      }
    '';
  };

  # Caddy needs read access to Step-CA certificates
  systemd.services.caddy.serviceConfig = {
    SupplementaryGroups = [ "step-ca" ];
  };

  # Step-CA root CA already in system trust store (certificates.nix)
  # No additional trust configuration needed

  # Open firewall ports
  networking.firewall.allowedTCPPorts = [ 80 443 ];
  networking.firewall.allowedUDPPorts = [ 443 ]; # HTTP/3 (QUIC)
}
```

### Per-Service Conversion Pattern

**Simple Service (most common):**

BEFORE (nginx):
```nix
services.nginx.virtualHosts."service.vulcan.lan" = {
  forceSSL = true;
  sslCertificate = "/var/lib/nginx-certs/service.vulcan.lan.crt";
  sslCertificateKey = "/var/lib/nginx-certs/service.vulcan.lan.key";
  locations."/" = {
    proxyPass = "http://localhost:8080";
  };
};
```

AFTER (Caddy):
```nix
services.caddy.virtualHosts."service.vulcan.lan" = {
  extraConfig = ''
    tls internal
    reverse_proxy localhost:8080
  '';
};
```

**Service with Retry Logic (Home Assistant, Grafana):**

BEFORE (nginx with upstream):
```nix
services.nginx.upstreams."service" = {
  servers = {
    "127.0.0.1:8080" = { max_fails = 0; };
  };
  extraConfig = ''
    keepalive 32;
    keepalive_timeout 60s;
  '';
};

services.nginx.virtualHosts."service.vulcan.lan" = {
  forceSSL = true;
  sslCertificate = "/var/lib/nginx-certs/service.vulcan.lan.crt";
  sslCertificateKey = "/var/lib/nginx-certs/service.vulcan.lan.key";
  locations."/" = {
    proxyPass = "http://service/";
    extraConfig = ''
      proxy_next_upstream error timeout http_502 http_503 http_504;
      proxy_next_upstream_tries 3;
      proxy_next_upstream_timeout 10s;
    '';
  };
};
```

AFTER (Caddy with health checks):
```nix
services.caddy.virtualHosts."service.vulcan.lan" = {
  extraConfig = ''
    tls internal
    reverse_proxy localhost:8080 {
      health_uri /
      health_interval 10s
      health_timeout 5s
    }
  '';
};
```

**WebSocket Service (Home Assistant):**

BEFORE (nginx):
```nix
services.nginx.virtualHosts."hass.vulcan.lan" = {
  forceSSL = true;
  sslCertificate = "/var/lib/nginx-certs/hass.vulcan.lan.crt";
  sslCertificateKey = "/var/lib/nginx-certs/hass.vulcan.lan.key";
  locations."/" = {
    proxyPass = "http://localhost:8123";
    proxyWebsockets = true;
  };
};
```

AFTER (Caddy - WebSocket automatic):
```nix
services.caddy.virtualHosts."hass.vulcan.lan" = {
  extraConfig = ''
    tls internal
    reverse_proxy localhost:8123
  '';
};
```

**Complex Service (Nagios with CGI, PHP, Auth):**

BEFORE (nginx):
```nix
services.nginx.virtualHosts."nagios.vulcan.lan" = {
  forceSSL = true;
  sslCertificate = "/var/lib/nginx-certs/nagios.vulcan.lan.crt";
  sslCertificateKey = "/var/lib/nginx-certs/nagios.vulcan.lan.key";
  basicAuthFile = "/var/lib/nagios/htpasswd";

  locations = {
    "/" = {
      root = "${pkgs.nagios}/share";
      index = "index.php index.html";
    };

    "~ ^/(nagios/)?cgi-bin/(.+\\.cgi)$" = {
      extraConfig = ''
        include ${pkgs.nginx}/conf/fastcgi_params;
        fastcgi_param AUTH_USER $remote_user;
        fastcgi_param REMOTE_USER $remote_user;
        fastcgi_param SCRIPT_FILENAME ${pkgs.nagios}/bin/$2;
        fastcgi_pass unix:/run/fcgiwrap-nagios.sock;
      '';
    };

    "~ \\.php$" = {
      extraConfig = ''
        include ${pkgs.nginx}/conf/fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_pass unix:/run/phpfpm/nagios.sock;
      '';
    };
  };
};
```

AFTER (Caddy):
```nix
services.caddy.virtualHosts."nagios.vulcan.lan" = {
  extraConfig = ''
    tls internal

    # Basic authentication
    basicauth {
      nagiosadmin $2y$05$... # bcrypt hash from htpasswd
    }

    # Root directory for static files
    root * ${pkgs.nagios}/share

    # PHP files via PHP-FPM
    php_fastcgi unix//run/phpfpm/nagios.sock {
      root ${pkgs.nagios}/share
    }

    # CGI scripts via fcgiwrap
    @cgi {
      path_regexp cgi ^/(nagios/)?cgi-bin/(.+\.cgi)$
    }
    reverse_proxy @cgi unix//run/fcgiwrap-nagios.sock {
      transport fastcgi {
        env SCRIPT_FILENAME ${pkgs.nagios}/bin/{re.cgi.2}
        env AUTH_USER {http.auth.user.id}
        env REMOTE_USER {http.auth.user.id}
        env NAGIOS_CGI_CONFIG ${nagiosCGICfgFile}
      }
    }

    # Serve static files
    file_server
  '';
};
```

### Certificate Trust Configuration

**No additional configuration needed!**

Since Caddy is configured to use the existing Step-CA certificates, the Step-CA root CA is already in the system trust store (configured in `/etc/nixos/modules/services/certificates.nix`).

All Caddy-issued certificates will be signed by the Step-CA intermediate CA, which chains to the already-trusted Step-CA root CA.

**Nagios SSL Certificate Checks:**

No changes needed to Nagios SSL certificate checks - they already use `/etc/ssl/certs/vulcan-ca.crt` which is the Step-CA root certificate.

---

## Implementation Plan

### Overview

The migration will be executed in 8 distinct phases, allowing for incremental progress and validation at each step.

### Phase 1: Preparation & Base Configuration
**Estimated Time:** 30 minutes
**Risk Level:** Low

**Tasks:**
1. Create backup of current nginx configuration
2. Document all nginx virtualHost configurations
3. Create new Caddy base configuration in `web.nix`
4. Verify Caddy package is available in nixpkgs
5. Create migration tracking document

**Deliverables:**
- Backup of `/etc/nixos/modules/services/web.nix`
- Documented list of all services (already complete)
- New `web.nix` with Caddy base configuration

**Validation:**
- Configuration builds successfully
- No services broken (Caddy not yet enabled)

### Phase 2: Convert Simple Services (Proof of Concept)
**Estimated Time:** 1 hour
**Risk Level:** Low
**Services:** Grafana, Prometheus, Alertmanager

**Tasks:**
1. Convert Grafana nginx → Caddy
2. Convert Prometheus nginx → Caddy
3. Convert Alertmanager nginx → Caddy
4. Remove nginx certificate generation services for these 3 services
5. Build and test configuration

**Validation Criteria:**
- Configuration builds without errors
- All 3 services accessible via HTTPS
- Certificates issued by Caddy Internal CA
- No browser certificate warnings after trusting Caddy CA
- Prometheus scraping still works
- Grafana dashboards load correctly

**Rollback:** Revert commits, rebuild with previous configuration

### Phase 3: Convert Home Automation Services
**Estimated Time:** 45 minutes
**Risk Level:** Medium
**Services:** Home Assistant, Node-RED

**Tasks:**
1. Convert Home Assistant nginx → Caddy (WebSocket critical)
2. Convert Node-RED nginx → Caddy
3. Remove nginx certificate services for these services
4. Build and test

**Validation Criteria:**
- Home Assistant web interface accessible
- Home Assistant WebSocket connections working (check browser console)
- Mobile app connectivity maintained
- HomeKit bridge still functioning
- Node-RED interface accessible
- Node-RED flows executing correctly

**Rollback:** Revert commits, rebuild

### Phase 4: Convert Database & Storage Services
**Estimated Time:** 30 minutes
**Risk Level:** Low
**Services:** PostgreSQL, Nextcloud

**Tasks:**
1. Convert PostgreSQL nginx → Caddy
2. Convert Nextcloud nginx → Caddy
3. Remove nginx certificate services
4. Build and test

**Validation Criteria:**
- PostgreSQL accessible via HTTPS (if exposed)
- Nextcloud web interface accessible
- Nextcloud sync clients working
- File uploads/downloads functioning

**Rollback:** Revert commits, rebuild

### Phase 5: Convert Monitoring & Visualization
**Estimated Time:** 45 minutes
**Risk Level:** Low
**Services:** Loki, Promtail, VictoriaMetrics, MRTG

**Tasks:**
1. Convert Loki nginx → Caddy
2. Convert Promtail nginx → Caddy
3. Convert VictoriaMetrics nginx → Caddy
4. Convert MRTG nginx → Caddy
5. Remove nginx certificate services
6. Build and test

**Validation Criteria:**
- Loki receiving logs from Promtail
- Grafana can query Loki datasource
- VictoriaMetrics scraping working
- MRTG graphs accessible and updating

**Rollback:** Revert commits, rebuild

### Phase 6: Convert Complex Services (Critical)
**Estimated Time:** 2 hours
**Risk Level:** HIGH
**Services:** Nagios (CGI + PHP + Auth), Jellyfin, Cockpit

**Tasks:**
1. Convert Nagios nginx → Caddy (most complex)
   - Basic authentication configuration
   - FastCGI for CGI scripts
   - PHP-FPM configuration
   - Static file serving
2. Test Nagios extensively:
   - Web interface loads
   - CGI scripts execute (service checks, status pages)
   - PHP pages render
   - Authentication works
   - Command submission works
3. Convert Jellyfin nginx → Caddy
4. Convert Cockpit nginx → Caddy
5. Remove nginx certificate services
6. Build and test

**Validation Criteria (Nagios - CRITICAL):**
- ✅ Nagios web interface loads at https://nagios.vulcan.lan
- ✅ Login with nagiosadmin works
- ✅ Service status page displays correctly
- ✅ Host status page displays correctly
- ✅ CGI scripts execute without errors
- ✅ PHP status pages render
- ✅ Can view service/host details
- ✅ Can submit external commands
- ✅ Notifications/alerts still function
- ✅ Performance graphs display

**Rollback:** Revert commits, rebuild (HIGH PRIORITY if Nagios fails)

### Phase 7: Convert Remaining Services
**Estimated Time:** 1.5 hours
**Risk Level:** Low
**Services:** All remaining (13 services)

**Tasks:**
1. Convert container services (Budget, ChangeDetection)
2. Convert utility services (DNS, Glance, LLama-Swap)
3. Convert external domain (home.newartisans.com)
4. Remove all remaining nginx certificate services
5. Build and test each service

**Validation Criteria:**
- All services accessible via HTTPS
- No certificate errors
- Functionality verified for each service

**Rollback:** Revert commits, rebuild

### Phase 8: Cleanup & Finalization
**Estimated Time:** 45 minutes
**Risk Level:** Low

**Tasks:**
1. **Disable nginx service:**
   - Remove `services.nginx.enable = true` from `web.nix`

2. **Remove nginx monitoring:**
   - Remove nginx-exporter service
   - Remove nginx Prometheus scrape config
   - Add Caddy metrics exporter (if available)
   - Update Nagios checks (remove "Nginx Web Server" check, add "Caddy Web Server")

3. **Remove nginx certificate infrastructure:**
   - Delete systemd services: `*-certificate.service`
   - Delete systemd timers: `*-cert-renewal.timer`
   - Remove scripts:
     - `/etc/nixos/certs/renew-nginx-certs.sh`
     - Any service-specific nginx cert renewal scripts

4. **Add Caddy root CA to system trust:**
   - Update `certificates.nix` to include Caddy CA
   - Update Nagios SSL checks to use Caddy CA root

5. **Clean up directories (manual):**
   - Archive `/var/lib/nginx-certs/` directory
   - Document location of archived certificates

6. **Update documentation:**
   - Update CLAUDE.md with Caddy information
   - Remove nginx-specific documentation
   - Add Caddy troubleshooting guide

7. **Final validation:**
   - All 23 services accessible
   - All SSL certificates valid
   - No nginx processes running
   - Nagios monitoring updated
   - Prometheus scraping updated

**Validation Criteria:**
- ✅ No nginx service running
- ✅ All services still accessible
- ✅ Caddy root CA trusted system-wide
- ✅ No nginx-related systemd units active
- ✅ Monitoring updated correctly
- ✅ Documentation updated

**Rollback:** Full revert to nginx (requires restoring all nginx configs)

---

## Testing Strategy

### Pre-Deployment Testing

**Build Validation:**
```bash
sudo nixos-rebuild build --flake '.#vulcan'
```
- Must complete without errors
- Review evaluation output for warnings

**Dry Run:**
```bash
sudo nixos-rebuild dry-activate --flake '.#vulcan'
```
- Review systemd unit changes
- Verify Caddy service will start
- Check for unexpected service restarts

### Service Testing Checklist

For each converted service, perform the following tests:

**Basic Connectivity:**
- [ ] Service accessible via HTTP (port 80)
- [ ] Automatic redirect to HTTPS
- [ ] Service accessible via HTTPS (port 443)
- [ ] No browser certificate warnings (after trusting Caddy CA)
- [ ] Correct certificate CN/SANs

**Functionality:**
- [ ] Service-specific functionality works (varies per service)
- [ ] API endpoints respond correctly
- [ ] WebSocket connections established (if applicable)
- [ ] File uploads work (if applicable)
- [ ] Authentication works (if applicable)

**Performance:**
- [ ] Response times acceptable
- [ ] No timeout errors
- [ ] Proxy headers passed correctly

**Monitoring:**
- [ ] Service shows as healthy in Nagios
- [ ] Prometheus metrics being scraped
- [ ] No errors in Caddy logs
- [ ] No errors in service logs

### Critical Service Testing (Nagios)

**Nagios requires extensive testing due to complexity:**

1. **Web Interface:**
   - [ ] https://nagios.vulcan.lan loads
   - [ ] Basic auth prompts for credentials
   - [ ] Login with nagiosadmin succeeds
   - [ ] Main dashboard displays

2. **CGI Functionality:**
   - [ ] status.cgi displays service status
   - [ ] status.cgi displays host status
   - [ ] extinfo.cgi shows host/service details
   - [ ] cmd.cgi (command submission) works
   - [ ] history.cgi shows event history
   - [ ] notifications.cgi displays notifications

3. **PHP Functionality:**
   - [ ] Any PHP pages render correctly
   - [ ] No PHP execution errors

4. **Static Files:**
   - [ ] CSS files load
   - [ ] JavaScript files load
   - [ ] Images display correctly
   - [ ] Nagios icons/logos appear

5. **Backend:**
   - [ ] Service checks executing
   - [ ] Host checks executing
   - [ ] Command file writable
   - [ ] External commands processing

### Monitoring Validation

After full migration:

**Nagios:**
- [ ] All service checks passing
- [ ] Host checks passing
- [ ] SSL certificate checks updated
- [ ] No false alarms

**Prometheus:**
- [ ] All targets up
- [ ] Metrics scraping successfully
- [ ] No scrape errors
- [ ] Grafana dashboards displaying data

---

## Rollback Plan

### Phase-Level Rollback

After each phase, if issues are detected:

1. **Identify failing services**
2. **Revert commits for that phase:**
   ```bash
   git log --oneline
   git revert <commit-hash>
   ```
3. **Rebuild:**
   ```bash
   sudo nixos-rebuild switch --flake '.#vulcan'
   ```
4. **Verify services restored**

### Full Rollback to Nginx

If a complete rollback is needed:

**Option 1: Git Revert (Recommended)**
```bash
# Revert all Caddy commits
git log --oneline | grep -i caddy
git revert <commit-hash-1> <commit-hash-2> ...

# Rebuild
sudo nixos-rebuild switch --flake '.#vulcan'
```

**Option 2: Git Reset (If no commits pushed)**
```bash
# Reset to before migration started
git reset --hard <pre-migration-commit>

# Rebuild
sudo nixos-rebuild switch --flake '.#vulcan'
```

**Option 3: Manual Restoration**
```bash
# Restore nginx configurations from backup
cp -r /path/to/backup/modules /etc/nixos/

# Rebuild
sudo nixos-rebuild switch --flake '.#vulcan'
```

### Emergency Rollback

If system is unstable or services are down:

1. **Boot into previous generation:**
   - Reboot
   - Select previous NixOS generation from bootloader menu

2. **Rollback via nixos-rebuild:**
   ```bash
   sudo nixos-rebuild switch --rollback
   ```

3. **Verify all services operational**

4. **Investigate root cause before retrying**

---

## Migration Phases

### Phase 1: Preparation (30 min)

**Checklist:**
- [ ] Backup current configuration: `cp -r /etc/nixos /etc/nixos.backup.$(date +%Y%m%d)`
- [ ] Review all nginx virtualHost configurations
- [ ] Create git branch for migration: `git checkout -b caddy-migration`
- [ ] Create base Caddy configuration in `web.nix`
- [ ] Test build: `sudo nixos-rebuild build --flake '.#vulcan'`
- [ ] Commit: `git commit -m "Phase 1: Add Caddy base configuration"`

**Files Modified:**
- `/etc/nixos/modules/services/web.nix`

**Expected Result:**
- Configuration builds successfully
- Caddy enabled but no virtualHosts yet
- Nginx still handling all traffic

---

### Phase 2: Simple Services POC (1 hour)

**Checklist:**
- [ ] Convert Grafana to Caddy
- [ ] Convert Prometheus to Caddy
- [ ] Convert Alertmanager to Caddy
- [ ] Remove nginx certificate services for these 3 services
- [ ] Test build
- [ ] Deploy: `sudo nixos-rebuild switch --flake '.#vulcan'`
- [ ] Verify Grafana accessible: `curl -k https://grafana.vulcan.lan`
- [ ] Verify Prometheus accessible: `curl -k https://prometheus.vulcan.lan`
- [ ] Verify Alertmanager accessible: `curl -k https://alertmanager.vulcan.lan`
- [ ] Check Grafana dashboards load
- [ ] Check Prometheus targets up
- [ ] Commit: `git commit -m "Phase 2: Convert Grafana, Prometheus, Alertmanager to Caddy"`

**Files Modified:**
- `/etc/nixos/modules/services/grafana.nix`
- `/etc/nixos/modules/monitoring/services/prometheus-nginx.nix`
- `/etc/nixos/modules/services/alertmanager.nix`

**Expected Result:**
- 3 services now on Caddy
- Certificates issued by Caddy Internal CA
- All functionality working

**Stop Condition:**
- If any service fails validation, rollback this phase

---

### Phase 3: Home Automation (45 min)

**Checklist:**
- [ ] Convert Home Assistant to Caddy
- [ ] Convert Node-RED to Caddy
- [ ] Remove nginx certificate services
- [ ] Test build
- [ ] Deploy
- [ ] Verify Home Assistant web interface
- [ ] Test Home Assistant WebSocket (check browser console for ws:// connections)
- [ ] Test Home Assistant mobile app
- [ ] Verify HomeKit bridge working
- [ ] Verify Node-RED interface accessible
- [ ] Test Node-RED flow execution
- [ ] Commit: `git commit -m "Phase 3: Convert Home Assistant and Node-RED to Caddy"`

**Files Modified:**
- `/etc/nixos/modules/services/home-assistant.nix`
- `/etc/nixos/modules/services/node-red.nix`

**Expected Result:**
- Home Assistant fully functional
- WebSocket connections working
- Mobile app connectivity maintained
- Node-RED operational

**Stop Condition:**
- If WebSocket connections fail, rollback immediately

---

### Phase 4: Database & Storage (30 min)

**Checklist:**
- [ ] Convert PostgreSQL to Caddy
- [ ] Convert Nextcloud to Caddy
- [ ] Remove nginx certificate services
- [ ] Test build
- [ ] Deploy
- [ ] Verify PostgreSQL accessible (if exposed)
- [ ] Verify Nextcloud web interface
- [ ] Test Nextcloud file upload
- [ ] Test Nextcloud sync client
- [ ] Commit: `git commit -m "Phase 4: Convert PostgreSQL and Nextcloud to Caddy"`

**Files Modified:**
- `/etc/nixos/modules/services/databases.nix`
- `/etc/nixos/modules/services/nextcloud.nix`

**Expected Result:**
- Database services accessible
- Nextcloud fully functional
- Sync clients working

**Stop Condition:**
- If Nextcloud sync breaks, rollback

---

### Phase 5: Monitoring & Visualization (45 min)

**Checklist:**
- [ ] Convert Loki to Caddy
- [ ] Convert Promtail to Caddy
- [ ] Convert VictoriaMetrics to Caddy
- [ ] Convert MRTG to Caddy
- [ ] Remove nginx certificate services
- [ ] Test build
- [ ] Deploy
- [ ] Verify Loki receiving logs
- [ ] Verify Grafana can query Loki
- [ ] Verify VictoriaMetrics scraping
- [ ] Verify MRTG graphs accessible
- [ ] Commit: `git commit -m "Phase 5: Convert monitoring services to Caddy"`

**Files Modified:**
- `/etc/nixos/modules/services/loki.nix`
- `/etc/nixos/modules/services/promtail.nix`
- `/etc/nixos/modules/monitoring/services/victoriametrics.nix`
- `/etc/nixos/modules/monitoring/mrtg.nix`

**Expected Result:**
- Log aggregation working
- Metrics collection operational
- Grafana dashboards displaying data

**Stop Condition:**
- If log collection stops, rollback

---

### Phase 6: Complex Services - Nagios (2 hours)

**⚠️ CRITICAL PHASE - PROCEED WITH CAUTION ⚠️**

**Checklist:**
- [ ] Study current Nagios nginx configuration carefully
- [ ] Create Caddy configuration for Nagios
- [ ] Convert Jellyfin to Caddy
- [ ] Convert Cockpit to Caddy
- [ ] Remove nginx certificate services
- [ ] Test build extensively
- [ ] Deploy
- [ ] **EXTENSIVE NAGIOS TESTING:**
  - [ ] Web interface loads at https://nagios.vulcan.lan
  - [ ] Basic auth prompts
  - [ ] Login with nagiosadmin succeeds
  - [ ] Main dashboard displays service status
  - [ ] Click on individual service - details page loads
  - [ ] Click on individual host - details page loads
  - [ ] Check "Service Problems" page
  - [ ] Check "Host Problems" page
  - [ ] Submit a test external command (re-check a service)
  - [ ] Verify command processed
  - [ ] Check PHP pages (if any) render
  - [ ] Verify CSS/JS/images load correctly
  - [ ] Open browser console - check for JavaScript errors
  - [ ] Check Nagios logs: `journalctl -u nagios -f`
  - [ ] Verify fcgiwrap service running: `systemctl status fcgiwrap-nagios`
  - [ ] Verify PHP-FPM pool running: `systemctl status phpfpm-nagios`
- [ ] Verify Jellyfin accessible and playing media
- [ ] Verify Cockpit accessible and functional
- [ ] Commit: `git commit -m "Phase 6: Convert Nagios, Jellyfin, Cockpit to Caddy"`

**Files Modified:**
- `/etc/nixos/modules/services/nagios.nix`
- `/etc/nixos/modules/services/media.nix`
- `/etc/nixos/modules/services/cockpit.nix`

**Expected Result:**
- Nagios fully functional with CGI, PHP, and auth
- All Nagios CGI scripts executing correctly
- Jellyfin streaming working
- Cockpit administration working

**Stop Condition:**
- If Nagios CGI scripts fail, ROLLBACK IMMEDIATELY
- If authentication breaks, ROLLBACK
- If commands cannot be submitted, ROLLBACK

**Notes:**
- This is the highest risk phase
- Nagios is critical for monitoring
- Take extra time to validate thoroughly
- Consider testing on a cloned VM first if possible

---

### Phase 7: Remaining Services (1.5 hours)

**Checklist:**
- [ ] Convert BudgetBoard to Caddy
- [ ] Convert ChangeDetection to Caddy
- [ ] Convert Technitium DNS to Caddy
- [ ] Convert Glance dashboard to Caddy
- [ ] Convert LLama-Swap to Caddy
- [ ] Convert vulcan.lan redirect to Caddy
- [ ] Do NOT convert home.newartisans.com to Caddy, leave that with nginx
- [ ] Remove all remaining nginx certificate services, except those used by secure-nginx.nix
- [ ] Test build
- [ ] Deploy
- [ ] Verify each service individually
- [ ] Commit: `git commit -m "Phase 7: Convert remaining services to Caddy"`

**Files Modified:**
- `/etc/nixos/modules/containers/budgetboard-quadlet.nix`
- `/etc/nixos/modules/containers/changedetection-quadlet.nix`
- `/etc/nixos/modules/services/dns.nix`
- `/etc/nixos/modules/services/glance.nix`
- `/etc/nixos/modules/services/llama-swap.nix`
- `/etc/nixos/modules/services/web.nix` (for redirects)

**Expected Result:**
- All 23 services now on Caddy
- No nginx virtualHosts remaining
- All services accessible and functional

**Stop Condition:**
- If any service fails, fix or rollback that service only

---

### Phase 8: Cleanup & Finalization (45 min)

**Checklist:**
- [ ] Disable nginx service in `web.nix`
- [ ] Remove nginx-exporter service
- [ ] Remove nginx from Prometheus scrape config
- [ ] Update Nagios checks (remove nginx, add Caddy check if desired)
- [ ] Remove all nginx certificate systemd services
- [ ] Remove all nginx certificate renewal timers
- [ ] Remove certificate renewal scripts from `/etc/nixos/certs/`
- [ ] Add Caddy root CA to system trust store
- [ ] Update Nagios SSL checks to use Caddy root CA
- [ ] Archive `/var/lib/nginx-certs/` directory
- [ ] Update CLAUDE.md documentation
- [ ] Test build
- [ ] Deploy
- [ ] **Final Validation:**
  - [ ] Run through all 23 services - verify accessible
  - [ ] Check Nagios - all service checks passing
  - [ ] Check Prometheus - all targets up
  - [ ] Verify no nginx processes running: `pgrep nginx` (should be empty)
  - [ ] Check Caddy logs: `journalctl -u caddy -f`
  - [ ] Verify Caddy root CA trusted: `curl https://grafana.vulcan.lan` (no cert error)
- [ ] Commit: `git commit -m "Phase 8: Complete nginx removal and cleanup"`
- [ ] Merge migration branch: `git checkout main && git merge caddy-migration`

**Files Modified:**
- `/etc/nixos/modules/services/web.nix`
- `/etc/nixos/modules/services/certificates.nix`
- `/etc/nixos/modules/services/nagios.nix`
- `/etc/nixos/modules/monitoring/services/prometheus-nginx.nix`
- `/etc/nixos/CLAUDE.md`
- Remove files: `/etc/nixos/certs/renew-nginx-certs.sh`, etc.

**Expected Result:**
- Nginx completely removed
- All services on Caddy
- Monitoring updated
- Documentation updated
- System stable and operational

**Final Checkpoint:**
- Take a full system snapshot/backup
- Document Caddy CA distribution instructions for clients
- Update any external monitoring that checks nginx
- Celebrate successful migration! 🎉

---

## Service Conversion Reference

### Quick Reference Table

| Service | Complexity | WebSocket | Auth | Special Config |
|---------|-----------|-----------|------|----------------|
| Grafana | Low | No | No | Health checks |
| Prometheus | Low | No | No | - |
| Alertmanager | Low | No | No | - |
| Home Assistant | Medium | **YES** | No | Health checks |
| Node-RED | Low | No | No | - |
| PostgreSQL | Low | No | No | - |
| Nextcloud | Medium | No | No | Large file uploads |
| Loki | Low | No | No | - |
| Promtail | Low | No | No | - |
| VictoriaMetrics | Low | No | No | - |
| MRTG | Low | No | No | - |
| **Nagios** | **VERY HIGH** | No | **YES** | **CGI, PHP, FastCGI** |
| Jellyfin | Medium | No | No | Large file streaming |
| Cockpit | Low | No | No | - |
| BudgetBoard | Low | No | No | - |
| ChangeDetection | Low | No | No | - |
| Technitium DNS | Low | No | No | - |
| Glance | Low | No | No | - |
| LLama-Swap | Low | No | No | - |
| vulcan.lan | Low | No | No | HTTP redirect only |
| home.newartisans.com | Low | No | No | External domain |

### Complexity Definitions

**Low:** Simple reverse proxy, no special configuration
**Medium:** Requires health checks, WebSocket support, or special headers
**High:** Multiple backend services, load balancing, or complex routing
**Very High:** FastCGI, CGI, PHP-FPM, authentication, multiple location blocks

### Configuration Snippets

**Simple Reverse Proxy:**
```nix
services.caddy.virtualHosts."service.vulcan.lan" = {
  extraConfig = ''
    tls internal
    reverse_proxy localhost:PORT
  '';
};
```

**With Health Checks:**
```nix
services.caddy.virtualHosts."service.vulcan.lan" = {
  extraConfig = ''
    tls internal
    reverse_proxy localhost:PORT {
      health_uri /health
      health_interval 10s
      health_timeout 5s
    }
  '';
};
```

**Basic Authentication:**
```nix
services.caddy.virtualHosts."service.vulcan.lan" = {
  extraConfig = ''
    tls internal
    basicauth {
      username $2y$05$... # bcrypt hash
    }
    reverse_proxy localhost:PORT
  '';
};
```

**Static File Serving:**
```nix
services.caddy.virtualHosts."service.vulcan.lan" = {
  extraConfig = ''
    tls internal
    root * /path/to/files
    file_server
  '';
};
```

**PHP FastCGI:**
```nix
services.caddy.virtualHosts."service.vulcan.lan" = {
  extraConfig = ''
    tls internal
    root * /path/to/root
    php_fastcgi unix//run/phpfpm/pool.sock
    file_server
  '';
};
```

**HTTP Redirect:**
```nix
services.caddy.virtualHosts."old.vulcan.lan" = {
  extraConfig = ''
    redir https://new.vulcan.lan{uri} permanent
  '';
};
```

---

## Post-Migration Tasks

### Client Certificate Trust

**No action required!**

Since Caddy is using the existing Step-CA certificates, clients that already trust the Step-CA root certificate will automatically trust all Caddy-issued certificates.

**If clients don't already trust Step-CA:**

The Step-CA root certificate is already available at:
- System location: `/etc/ssl/certs/vulcan-ca.crt`
- Step-CA directory: `/var/lib/step-ca-state/certs/root_ca.crt`

Follow standard procedures to install the Step-CA root certificate on client devices (same process as before migration).

### Monitoring Updates

**Nagios:**
- Update service check: Change "Nginx Web Server" to "Caddy Web Server"
- Update SSL certificate checks root CA path
- Verify all checks passing after migration

**Prometheus:**
- Remove nginx-exporter target
- Add Caddy metrics exporter (if available)
- Update scrape configs
- Verify all targets up

**Alerting:**
- Review alert rules for nginx-specific metrics
- Update or disable as appropriate
- Add Caddy-specific alerts if desired

### Documentation Updates

**CLAUDE.md:**
- Add Caddy section
- Remove nginx-specific information
- Add Caddy certificate management instructions
- Add Caddy troubleshooting guide

**README.md:**
- Update service descriptions
- Update "Web Services" section
- Add Caddy version information

### Performance Baseline

After migration completes, establish new performance baselines:

1. **Response Time Metrics:**
   - Measure average response times for each service
   - Compare with pre-migration baselines (if available)
   - Document any significant changes

2. **Resource Usage:**
   - Measure Caddy CPU usage
   - Measure Caddy memory usage
   - Compare with nginx resource usage

3. **Throughput:**
   - Test large file uploads/downloads
   - Verify WebSocket connection limits
   - Document maximum concurrent connections

---

## Troubleshooting Guide

### Common Issues

**Issue:** Certificate warnings in browser after migration
**Cause:** Step-CA root certificate not trusted on client
**Solution:** Install Step-CA root certificate on client device (same as before migration - no changes needed)

---

**Issue:** Service returns "502 Bad Gateway"
**Cause:** Backend service not running or wrong port
**Solution:**
```bash
# Check if backend service is running
systemctl status SERVICE_NAME

# Check Caddy logs
journalctl -u caddy -f

# Verify port in Caddy config matches backend
```

---

**Issue:** Nagios CGI scripts return "403 Forbidden"
**Cause:** FastCGI transport misconfiguration or permissions
**Solution:**
```bash
# Check fcgiwrap service
systemctl status fcgiwrap-nagios

# Verify Unix socket permissions
ls -la /run/fcgiwrap-nagios.sock

# Check Caddy logs for detailed error
journalctl -u caddy -n 50
```

---

**Issue:** Nagios authentication not working
**Cause:** Htpasswd file path incorrect or bcrypt hash issue
**Solution:**
```bash
# Verify htpasswd file exists and readable
ls -la /var/lib/nagios/htpasswd

# Test htpasswd file
sudo cat /var/lib/nagios/htpasswd

# Regenerate hash if needed
echo "nagiosadmin:$(htpasswd -nbB nagiosadmin 'PASSWORD' | cut -d: -f2)"
```

---

**Issue:** Home Assistant WebSocket connections failing
**Cause:** Proxy configuration missing WebSocket support (unlikely with Caddy)
**Solution:**
```bash
# Check browser console for WebSocket errors
# Caddy supports WebSocket by default - check backend service

# Verify Home Assistant is running
systemctl status home-assistant

# Check Home Assistant logs
journalctl -u home-assistant -f
```

---

**Issue:** Large file uploads failing in Nextcloud
**Cause:** Default upload size limits
**Solution:** Add to Nextcloud Caddy config:
```nix
request_body {
  max_size 10GB
}
```

---

**Issue:** Caddy service fails to start
**Cause:** Configuration syntax error
**Solution:**
```bash
# Test Caddy configuration
caddy validate --config /etc/caddy/Caddyfile

# Check systemd logs
journalctl -u caddy -n 50

# Try manual start for better error messages
sudo -u caddy caddy run --config /etc/caddy/Caddyfile
```

---

**Issue:** "Unable to obtain certificate" error
**Cause:** Caddy Internal CA initialization failed
**Solution:**
```bash
# Check Caddy data directory exists
ls -la /data/caddy/

# Check permissions
sudo chown -R caddy:caddy /data/caddy/

# Restart Caddy
systemctl restart caddy

# Check logs
journalctl -u caddy -f
```

---

## Appendix A: File Change Summary

### Files to Modify

| File | Changes | Phase |
|------|---------|-------|
| `modules/services/web.nix` | Replace nginx with Caddy base config | 1 |
| `modules/services/grafana.nix` | Convert nginx → Caddy | 2 |
| `modules/monitoring/services/prometheus-nginx.nix` | Convert nginx → Caddy | 2 |
| `modules/services/alertmanager.nix` | Convert nginx → Caddy | 2 |
| `modules/services/home-assistant.nix` | Convert nginx → Caddy | 3 |
| `modules/services/node-red.nix` | Convert nginx → Caddy | 3 |
| `modules/services/databases.nix` | Convert nginx → Caddy | 4 |
| `modules/services/nextcloud.nix` | Convert nginx → Caddy | 4 |
| `modules/services/loki.nix` | Convert nginx → Caddy | 5 |
| `modules/services/promtail.nix` | Convert nginx → Caddy | 5 |
| `modules/monitoring/services/victoriametrics.nix` | Convert nginx → Caddy | 5 |
| `modules/monitoring/mrtg.nix` | Convert nginx → Caddy | 5 |
| `modules/services/nagios.nix` | Convert nginx → Caddy (COMPLEX) | 6 |
| `modules/services/media.nix` | Convert nginx → Caddy | 6 |
| `modules/services/cockpit.nix` | Convert nginx → Caddy | 6 |
| `modules/containers/budgetboard-quadlet.nix` | Convert nginx → Caddy | 7 |
| `modules/containers/changedetection-quadlet.nix` | Convert nginx → Caddy | 7 |
| `modules/services/dns.nix` | Convert nginx → Caddy | 7 |
| `modules/services/glance.nix` | Convert nginx → Caddy | 7 |
| `modules/services/llama-swap.nix` | Convert nginx → Caddy | 7 |
| `modules/services/certificates.nix` | Add Caddy root CA | 8 |
| `CLAUDE.md` | Update documentation | 8 |

### Files to Remove

| File | Description | Phase |
|------|-------------|-------|
| `certs/renew-nginx-certs.sh` | Nginx cert renewal script | 8 |
| `modules/monitoring/services/nginx-exporter.nix` | Nginx Prometheus exporter | 8 |
| All `*-certificate.service` systemd units | Nginx cert generation services | 8 |
| All `*-cert-renewal.timer` systemd units | Nginx cert renewal timers | 8 |

---

## Appendix B: Caddy Resources

### Official Documentation
- **Caddy Docs:** https://caddyserver.com/docs/
- **Caddyfile Syntax:** https://caddyserver.com/docs/caddyfile
- **reverse_proxy Directive:** https://caddyserver.com/docs/caddyfile/directives/reverse_proxy
- **tls Directive:** https://caddyserver.com/docs/caddyfile/directives/tls
- **Internal CA:** https://caddyserver.com/docs/automatic-https#internal-ca

### NixOS Caddy Module
- **NixOS Manual:** https://nixos.org/manual/nixos/stable/index.html#module-services-caddy
- **Source Code:** https://github.com/NixOS/nixpkgs/blob/master/nixos/modules/services/web-servers/caddy/default.nix

### Community Resources
- **Caddy Community Forum:** https://caddy.community/
- **Caddy GitHub:** https://github.com/caddyserver/caddy
- **NixOS Discourse:** https://discourse.nixos.org/

---

## Appendix C: Pre-Migration Checklist

Before beginning the migration, ensure:

- [ ] Full backup of `/etc/nixos` directory
- [ ] Git repository is clean (no uncommitted changes)
- [ ] Current system is stable (no ongoing issues)
- [ ] All services are currently accessible
- [ ] Nagios shows all services healthy
- [ ] Prometheus shows all targets up
- [ ] You have console/physical access to the server (in case of emergency)
- [ ] You have allocated 4-6 hours for the full migration
- [ ] You have reviewed the entire PRD
- [ ] You understand the rollback procedures
- [ ] You have tested the backup restoration process (optional but recommended)

---

## Appendix D: Success Criteria

Migration is considered successful when:

- [ ] All 23 services accessible via HTTPS
- [ ] No nginx processes running
- [ ] All certificates issued by Caddy Internal CA
- [ ] No browser certificate warnings (after trusting Caddy CA)
- [ ] Nagios monitoring shows all services healthy
- [ ] Prometheus scraping all targets successfully
- [ ] All service-specific functionality validated
- [ ] Nagios CGI scripts execute correctly
- [ ] Home Assistant WebSocket connections working
- [ ] No errors in Caddy logs
- [ ] System resources (CPU/memory) usage acceptable
- [ ] Documentation updated
- [ ] Rollback plan tested and validated

---

## Conclusion

This PRD provides a comprehensive plan for migrating from nginx to Caddy on the vulcan NixOS system. The migration is broken into 8 distinct phases, each with clear deliverables, validation criteria, and rollback procedures.

**Key Success Factors:**
1. Execute phases in order
2. Validate thoroughly after each phase
3. Don't rush - take time to test
4. Pay special attention to Nagios (Phase 6)
5. Document any issues encountered
6. Keep detailed notes of changes made

**Estimated Total Time:** 4-6 hours (can be spread across multiple sessions)

**Risk Assessment:** Medium overall, High for Phase 6 (Nagios)

**Recommendation:** Execute phases 1-2 in first session to validate approach, then proceed with remaining phases in subsequent sessions.

---

**Document Version History:**

- v1.0 (2025-10-31): Initial PRD created by Claude Code
- Approved by: [Pending User Review]
- Status: Ready for Execution
