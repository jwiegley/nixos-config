groups:
  - name: changedetection_service
    interval: 60s
    rules:
      - alert: ChangeDetectionAppDown
        expr: systemd_unit_state{name="changedetection.service",state="active"} == 0
        for: 2m
        labels:
          severity: critical
          component: changedetection
        annotations:
          summary: "ChangeDetection.io service is down"
          description: |
            ChangeDetection.io service has been down for {{ $value }} minutes.
            Website change monitoring service is unavailable.

            Check service status: systemctl status changedetection.service
            Check container: podman ps -a | grep changedetection
            View logs: journalctl -u changedetection.service -f
            Check podman logs: podman logs --user changedetection changedetection

      - alert: ChangeDetectionHTTPSProbeFailed
        expr: probe_success{job="blackbox_https_local",instance="https://changes.vulcan.lan"} == 0
        for: 5m
        labels:
          severity: critical
          component: changedetection
        annotations:
          summary: "ChangeDetection.io HTTPS probe failed"
          description: |
            ChangeDetection.io web interface at https://changes.vulcan.lan is not responding.
            Website change monitoring interface is inaccessible.

            Check nginx status: systemctl status nginx
            Check SSL certificate: curl -vI https://changes.vulcan.lan
            Check app container: podman ps --user changedetection | grep changedetection
            Test local endpoint: curl -I http://127.0.0.1:5055

      - alert: ChangeDetectionSlowResponse
        expr: probe_duration_seconds{job="blackbox_https_local",instance="https://changes.vulcan.lan"} > 10
        for: 10m
        labels:
          severity: warning
          component: changedetection
        annotations:
          summary: "ChangeDetection.io is responding slowly"
          description: |
            ChangeDetection.io response time is {{ $value }}s (threshold: 10s).
            Web interface may be slow due to high scraping activity.

            Check container resources: podman stats --user changedetection changedetection
            View recent activity: podman logs --user changedetection changedetection --tail 50
            Check fetch worker count: podman exec --user changedetection changedetection env | grep FETCH_WORKERS

      - alert: ChangeDetectionContainerRestarts
        expr: rate(systemd_unit_state{name="changedetection.service",state="failed"}[15m]) > 0
        for: 5m
        labels:
          severity: warning
          component: changedetection
        annotations:
          summary: "ChangeDetection.io container is restarting frequently"
          description: |
            ChangeDetection.io container has restarted {{ $value }} times in the last 15 minutes.
            This indicates instability.

            View recent logs: journalctl -u changedetection.service --since "15 minutes ago"
            Check container logs: podman logs --user changedetection changedetection --tail 100
            Check for OOM: dmesg | grep -i "changedetection\|oom"
            Check datastore integrity: ls -la /var/lib/changedetection
