# Quadlet Guide for NixOS

## What is Quadlet?

Quadlet is a systemd generator for Podman that converts simple `.container` files into full systemd service units. It provides native systemd integration for containers, making them first-class citizens in your system.

## Why Quadlet is Better

### vs Traditional Podman
- **Native systemd integration**: Containers are managed like any other systemd service
- **Automatic restarts**: Built-in systemd restart policies
- **Dependency management**: Proper service ordering with After/Wants/Requires
- **Resource limits**: CPU/memory limits via systemd
- **Logging**: Unified logging through journald
- **No daemon required**: Unlike Docker, runs rootless by default

### vs docker-compose
- **No separate orchestrator**: Systemd is the orchestrator
- **Better OS integration**: Containers start/stop with system boot/shutdown
- **Native secrets handling**: Integrates with systemd credentials and SOPS
- **Simpler**: No YAML indirection, direct systemd units

## Essential Commands

### Service Management
```bash
# Start/stop/restart containers (they're just services now!)
sudo systemctl start litellm.service
sudo systemctl stop wallabag.service
sudo systemctl restart organizr.service

# Check status
sudo systemctl status litellm.service
sudo systemctl status --all '*container*'  # All quadlet services

# Enable/disable auto-start
sudo systemctl enable litellm.service
sudo systemctl disable wallabag.service

# View logs
sudo journalctl -u litellm.service -f          # Follow logs
sudo journalctl -u wallabag.service -n 50      # Last 50 lines
sudo journalctl -u organizr.service --since "10 minutes ago"
sudo journalctl -u silly-tavern.service -p err  # Only errors

# Check dependencies
systemctl list-dependencies litellm.service
systemctl list-dependencies --reverse postgresql.service  # What depends on postgres
```

### Container Inspection
```bash
# List running containers
sudo podman ps

# Detailed container info
sudo podman inspect litellm
sudo podman stats              # Live resource usage
sudo podman top litellm        # Processes in container

# Execute commands in container
sudo podman exec -it litellm /bin/bash
sudo podman exec wallabag ls -la /var/www/wallabag

# View container logs (alternative to journalctl)
sudo podman logs litellm -f
sudo podman logs wallabag --since 5m
```

### Monitoring Tools (Already Installed)
```bash
# Interactive container dashboard
lazydocker                     # Full-featured TUI dashboard

# Podman-native TUI
podman-tui                     # Official Podman terminal UI
```

### Network Troubleshooting
```bash
# Check network configuration
sudo podman network inspect podman
sudo podman port litellm       # Port mappings

# Test connectivity
sudo podman exec litellm curl http://10.88.0.1:5432  # Test from container
```

### Advanced Systemd Integration
```bash
# View generated service files
cat /etc/systemd/system/litellm.service
systemctl cat litellm.service   # With overrides

# Reload if you manually edit .container files
sudo systemctl daemon-reload

# View unit file load path
systemctl show -p FragmentPath litellm.service

# Check timers (if any)
systemctl list-timers

# Resource usage
systemd-cgtop                   # Container resource usage in real-time
systemctl show litellm.service -p MemoryCurrent -p CPUUsageNSec
```

### Quadlet-Specific Locations
```bash
# Container definitions (generated by NixOS)
ls -la /etc/containers/systemd/*.container

# View original container definition
cat /etc/containers/systemd/litellm.container

# Systemd generator output
ls -la /run/systemd/generator/
```

## Quick Troubleshooting

### Container won't start
```bash
# Check status and recent logs
sudo systemctl status wallabag.service
sudo journalctl -xeu wallabag.service

# Reset failed state and retry
sudo systemctl reset-failed wallabag.service
sudo systemctl restart wallabag.service

# Check if port is already in use
sudo ss -tulpn | grep :4000
```

### Container can't connect to database
```bash
# Test from container network
sudo podman run --rm --network podman alpine ping 10.88.0.1
sudo podman exec litellm nc -zv 10.88.0.1 5432
```

### View all Quadlet services at once
```bash
# Status of all Quadlet containers
for service in litellm organizr silly-tavern wallabag; do
    echo "=== $service ==="
    sudo systemctl is-active $service.service
done

# Quick health check
sudo podman ps --format "table {{.Names}} {{.Status}} {{.Ports}}"
```

## NixOS-Specific Benefits

1. **Declarative**: Container definitions in Nix configuration
2. **Reproducible**: Same config = same deployment
3. **Integrated secrets**: SOPS secrets work seamlessly
4. **Atomic updates**: Rollback if something breaks
5. **Dependencies**: PostgreSQL, Redis, etc. managed together

## Your Current Services

| Service | Port | URL | Purpose |
|---------|------|-----|---------|
| LiteLLM | 4000 | https://litellm.vulcan.lan | AI model proxy |
| Organizr | 8080 | https://organizr.vulcan.lan | Dashboard |
| SillyTavern | 8083 | https://silly-tavern.vulcan.lan | AI chat interface |
| Wallabag | 9091 | https://wallabag.vulcan.lan | Read-it-later service |

## Pro Tips

1. **Logs are your friend**: `journalctl -f` shows all system logs in real-time
2. **Tab completion works**: Type `sudo systemctl restart lit<TAB>`
3. **Use systemd timers**: Better than cron for container tasks
4. **Resource limits**: Set in NixOS config via `serviceConfig.MemoryMax`, etc.
5. **Health checks**: Can be added via systemd's `ExecHealthCheck`

## Managing Updates

```bash
# Update container images
sudo podman pull ghcr.io/berriai/litellm-database:main-stable
sudo systemctl restart litellm.service

# Or rebuild NixOS to update all
sudo nixos-rebuild switch --flake .#vulcan
```

## Quick Status Script

Save this as `/usr/local/bin/container-status`:

```bash
#!/usr/bin/env bash
echo "=== Quadlet Container Status ==="
printf "%-15s %-10s %-8s %s\n" "SERVICE" "STATUS" "UPTIME" "PORTS"
echo "------------------------------------------------"
for service in litellm organizr silly-tavern wallabag; do
    status=$(systemctl is-active $service.service)
    if [ "$status" = "active" ]; then
        info=$(sudo podman ps --filter "name=$service" --format "{{.Status}}|{{.Ports}}" 2>/dev/null)
        uptime=$(echo "$info" | cut -d'|' -f1)
        ports=$(echo "$info" | cut -d'|' -f2)
        printf "%-15s %-10s %-8s %s\n" "$service" "✓ active" "$uptime" "$ports"
    else
        printf "%-15s %-10s %-8s %s\n" "$service" "✗ $status" "-" "-"
    fi
done
```

Remember: Your containers are now just systemd services. Everything you know about systemd applies!