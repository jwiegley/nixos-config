groups:
  - name: openproject
    interval: 30s
    rules:
      # OpenProject service availability
      - alert: OpenProjectDown
        expr: up{job="openproject"} == 0
        for: 3m
        labels:
          severity: critical
          service: openproject
        annotations:
          summary: "OpenProject service is down"
          description: "OpenProject has been unavailable for more than 3 minutes on {{ $labels.instance }}"

      # OpenProject HTTP health check (via blackbox)
      - alert: OpenProjectHTTPDown
        expr: probe_success{job="blackbox_https_local", instance=~".*openproject.*"} == 0
        for: 3m
        labels:
          severity: critical
          service: openproject
        annotations:
          summary: "OpenProject HTTP endpoint unreachable"
          description: "OpenProject HTTPS endpoint is unreachable for more than 3 minutes"

      # Puma worker count (ensure web workers are running)
      - alert: OpenProjectNoWorkers
        expr: puma_workers{job="openproject"} == 0
        for: 2m
        labels:
          severity: critical
          service: openproject
        annotations:
          summary: "OpenProject has no Puma workers"
          description: "OpenProject has no active Puma web workers on {{ $labels.instance }}"

      # High request queue (requests waiting)
      - alert: OpenProjectHighRequestQueue
        expr: puma_pool_capacity{job="openproject"} == 0
        for: 5m
        labels:
          severity: warning
          service: openproject
        annotations:
          summary: "OpenProject request queue is full"
          description: "OpenProject has no available capacity in the request pool for more than 5 minutes"

      # High memory usage
      - alert: OpenProjectHighMemoryUsage
        expr: |
          process_resident_memory_bytes{job="openproject"} > 2147483648
        for: 15m
        labels:
          severity: warning
          service: openproject
        annotations:
          summary: "OpenProject memory usage is high"
          description: "OpenProject is using {{ $value | humanize1024 }}B of memory on {{ $labels.instance }}"

      # Database connection issues
      - alert: OpenProjectDatabaseErrors
        expr: |
          increase(rails_active_record_connection_pool_errors_total{job="openproject"}[5m]) > 5
        for: 5m
        labels:
          severity: critical
          service: openproject
        annotations:
          summary: "OpenProject has database connection errors"
          description: "OpenProject has {{ $value }} database connection errors in the last 5 minutes"

      # High request error rate
      - alert: OpenProjectHighErrorRate
        expr: |
          rate(rails_requests_total{job="openproject",status=~"5.."}[5m]) /
          rate(rails_requests_total{job="openproject"}[5m]) > 0.05
        for: 10m
        labels:
          severity: warning
          service: openproject
        annotations:
          summary: "OpenProject has high HTTP error rate"
          description: "OpenProject HTTP 5xx error rate is above 5% on {{ $labels.instance }}"

      # Slow response times (95th percentile > 10 seconds)
      - alert: OpenProjectSlowResponse
        expr: |
          histogram_quantile(0.95,
            rate(rails_request_duration_seconds_bucket{job="openproject"}[5m])
          ) > 10
        for: 15m
        labels:
          severity: warning
          service: openproject
        annotations:
          summary: "OpenProject has slow response times"
          description: "95th percentile response time is {{ $value | humanizeDuration }} on {{ $labels.instance }}"

      # Background job queue backing up (if ActiveJob metrics are available)
      - alert: OpenProjectJobQueueBacklog
        expr: |
          activejob_jobs_queue_size{job="openproject"} > 500
        for: 30m
        labels:
          severity: warning
          service: openproject
        annotations:
          summary: "OpenProject job queue has large backlog"
          description: "OpenProject has {{ $value }} pending background jobs on {{ $labels.instance }}"

      # Redis connection issues
      - alert: OpenProjectRedisDown
        expr: |
          redis_up{instance=~".*:6383"} == 0
        for: 2m
        labels:
          severity: critical
          service: openproject
        annotations:
          summary: "OpenProject Redis is down"
          description: "Redis server for OpenProject is unreachable"

      # Container health check
      - alert: OpenProjectContainerUnhealthy
        expr: |
          container_health_status{container_name="openproject"} == 0
        for: 5m
        labels:
          severity: warning
          service: openproject
        annotations:
          summary: "OpenProject container is unhealthy"
          description: "OpenProject container health check has been failing for more than 5 minutes"
