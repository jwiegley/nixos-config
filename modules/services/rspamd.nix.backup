{ config, lib, pkgs, ... }:

let
  # Rspamd controller password will be managed via SOPS
  controllerPasswordFile = config.sops.secrets."rspamd-controller-password".path;

  # Helper script to scan mailboxes with rspamc
  mailboxScannerScript = pkgs.writeShellScript "rspamd-scan-mailboxes" ''
    set -euo pipefail

    # Configuration
    USERS=("johnw" "assembly")
    MAIL_ROOT="/var/mail"
    SPAM_THRESHOLD=15  # Rspamd score threshold for spam
    RSPAMC="${pkgs.rspamd}/bin/rspamc"

    # Function to scan a single mailbox
    scan_mailbox() {
      local user=$1
      local mailbox=$2
      local maildir="$MAIL_ROOT/$user/$mailbox"

      if [ ! -d "$maildir/new" ] && [ ! -d "$maildir/cur" ]; then
        echo "Skipping non-existent mailbox: $maildir"
        return
      fi

      echo "Scanning mailbox: $user/$mailbox"

      # Scan messages in new/ and cur/ directories
      for dir in new cur; do
        if [ -d "$maildir/$dir" ]; then
          for msg in "$maildir/$dir"/*; do
            if [ -f "$msg" ]; then
              # Scan message with rspamc
              result=$($RSPAMC --json < "$msg" 2>/dev/null || true)

              # Extract score from JSON result
              score=$(echo "$result" | ${pkgs.jq}/bin/jq -r '.default.score // 0' 2>/dev/null || echo "0")

              # If score exceeds threshold, move to Spam folder
              if (( $(echo "$score > $SPAM_THRESHOLD" | ${pkgs.bc}/bin/bc -l) )); then
                spam_dir="$MAIL_ROOT/$user/Spam/cur"
                mkdir -p "$spam_dir"

                # Move message to Spam folder
                mv "$msg" "$spam_dir/"
                echo "  Moved spam message (score: $score): $(basename "$msg")"
              fi
            fi
          done
        fi
      done
    }

    # Scan mailboxes for each user
    for user in "''${USERS[@]}"; do
      echo "Processing user: $user"

      # Scan INBOX and common folders (skip Spam, TrainSpam, IsSpam to avoid loops)
      for mailbox in "INBOX" "Sent" "Drafts" "NeedsRule" "TrainGood" "IsGood"; do
        if [ -d "$MAIL_ROOT/$user/$mailbox" ]; then
          scan_mailbox "$user" "$mailbox"
        fi
      done

      # Scan mail/ and list/ subfolders if they exist
      if [ -d "$MAIL_ROOT/$user/mail" ]; then
        for subfolder in "$MAIL_ROOT/$user/mail"/*; do
          if [ -d "$subfolder" ]; then
            scan_mailbox "$user" "mail/$(basename "$subfolder")"
          fi
        done
      fi

      if [ -d "$MAIL_ROOT/$user/list" ]; then
        for subfolder in "$MAIL_ROOT/$user/list"/*; do
          if [ -d "$subfolder" ]; then
            scan_mailbox "$user" "list/$(basename "$subfolder")"
          fi
        done
      fi
    done

    echo "Mailbox scanning complete"
  '';

  # Sieve script for learning spam (when moved to TrainSpam)
  learnSpamScript = pkgs.writeText "learn-spam.sieve" ''
    require ["vnd.dovecot.pipe", "copy", "imapsieve", "environment", "variables", "fileinto"];

    if environment :matches "imap.mailbox" "*" {
      set "mailbox" "''${1}";
    }

    if string "''${mailbox}" "TrainSpam" {
      pipe :copy "rspamd-learn-spam.sh";
    }
  '';

  # Sieve script for learning ham (when moved to TrainGood)
  learnHamScript = pkgs.writeText "learn-ham.sieve" ''
    require ["vnd.dovecot.pipe", "copy", "imapsieve", "environment", "variables", "fileinto"];

    if environment :matches "imap.mailbox" "*" {
      set "mailbox" "''${1}";
    }

    if string "''${mailbox}" "TrainGood" {
      pipe :copy "rspamd-learn-ham.sh";
    }
  '';

  # Shell script to call rspamc learn_spam
  learnSpamShellScript = pkgs.writeShellScript "rspamd-learn-spam.sh" ''
    exec ${pkgs.rspamd}/bin/rspamc -h /run/rspamd/worker-controller.socket learn_spam
  '';

  # Shell script to call rspamc learn_ham
  learnHamShellScript = pkgs.writeShellScript "rspamd-learn-ham.sh" ''
    exec ${pkgs.rspamd}/bin/rspamc -h /run/rspamd/worker-controller.socket learn_ham
  '';

  # Sieve script to move trained spam to IsSpam folder
  moveToIsSpamScript = pkgs.writeText "move-to-isspam.sieve" ''
    require ["fileinto", "imap4flags"];

    # Move all messages in TrainSpam to IsSpam after learning
    fileinto "IsSpam";
  '';

  # Sieve script to move trained ham to IsGood folder
  moveToIsGoodScript = pkgs.writeText "move-to-isgood.sieve" ''
    require ["fileinto", "imap4flags"];

    # Move all messages in TrainGood to IsGood after learning
    fileinto "IsGood";
  '';
in
{
  # SOPS secret for Rspamd controller password
  sops.secrets."rspamd-controller-password" = {
    owner = "rspamd";
    mode = "0400";
    restartUnits = [ "rspamd.service" ];
  };

  # SOPS secret for Rspamd PostgreSQL password
  sops.secrets."rspamd-db-password" = {
    owner = "rspamd";
    mode = "0400";
    restartUnits = [ "rspamd.service" ];
  };

  # Create rspamd user and group
  users.users.rspamd = {
    isSystemUser = true;
    group = "rspamd";
    description = "Rspamd spam filtering daemon";
  };
  users.groups.rspamd = {};

  # Enable Rspamd service
  services.rspamd = {
    enable = true;

    # Use local Redis instance for statistics
    locals = {
      "redis.conf".text = ''
        # Redis backend configuration for Bayes classifier
        servers = "127.0.0.1:6380";
      '';

      "classifier-bayes.conf".text = ''
        # Use Redis backend for Bayes learning
        backend = "redis";
        servers = "127.0.0.1:6380";

        # Bayes classifier settings
        autolearn = true;
        min_learns = 10;
      '';

      "statistic.conf".text = ''
        # Statistics configuration
        classifier "bayes" {
          backend = "redis";
          servers = "127.0.0.1:6380";

          # Tokenizer settings
          tokenizer {
            name = "osb";
          }

          # Cache settings
          cache {
            type = "redis";
            servers = "127.0.0.1:6380";
          }

          # Minimum learns before autolearn kicks in
          min_learns = 10;

          # Autolearn settings
          autolearn {
            spam_threshold = 12.0;
            ham_threshold = -5.0;
          }
        }
      '';

      "actions.conf".text = ''
        # Action thresholds
        actions {
          reject = 15;
          add_header = 6;
          greylist = 4;
        }
      '';

      "worker-controller.inc".text = ''
        # Enable controller socket for rspamc
        bind_socket = "/run/rspamd/worker-controller.socket mode=0666 owner=rspamd";

        # Password for web UI and API
        password = "$${RSPAMD_CONTROLLER_PASSWORD}";

        # Enable history
        enable_password = "$${RSPAMD_CONTROLLER_PASSWORD}";
      '';

      "worker-normal.inc".text = ''
        # Normal worker configuration
        bind_socket = "/run/rspamd/worker-normal.socket mode=0666 owner=rspamd";

        # Use localhost for processing
        bind_socket = "localhost:11333";
      '';

      "worker-proxy.inc".text = ''
        # Proxy worker for milter protocol
        bind_socket = "localhost:11332";
        milter = yes;
        timeout = 120s;
        upstream "local" {
          default = yes;
          self_scan = yes;
        }
      '';

      "milter_headers.conf".text = ''
        # Add spam headers to messages
        use = ["x-spamd-bar", "x-spam-level", "x-spam-status", "authentication-results"];

        # Extended headers for better filtering
        extended_spam_headers = true;

        # Authentication results
        authentication-results {
          spf_symbols {
            pass = "R_SPF_ALLOW";
            fail = "R_SPF_FAIL";
            softfail = "R_SPF_SOFTFAIL";
            neutral = "R_SPF_NEUTRAL";
            temperror = "R_SPF_DNSFAIL";
            none = "R_SPF_NA";
            permerror = "R_SPF_PERMFAIL";
          }
          dkim_symbols {
            pass = "R_DKIM_ALLOW";
            fail = "R_DKIM_REJECT";
            temperror = "R_DKIM_TEMPFAIL";
            none = "R_DKIM_NA";
            permerror = "R_DKIM_PERMFAIL";
          }
        }
      '';

      "metrics.conf".text = ''
        # Prometheus metrics export
        group "web" {
          path = "/metrics";
        }
      '';
    };
  };

  # Redis instance for Rspamd (separate from other Redis instances)
  services.redis.servers.rspamd = {
    enable = true;
    port = 6380;
    bind = "127.0.0.1";
    requirePass = null;  # No password for local-only access
    save = [
      [900 1]    # Save after 900 sec if at least 1 key changed
      [300 10]   # Save after 300 sec if at least 10 keys changed
      [60 10000] # Save after 60 sec if at least 10000 keys changed
    ];
  };

  # PostgreSQL database for Rspamd history
  services.postgresql.ensureDatabases = [ "rspamd" ];
  services.postgresql.ensureUsers = [
    {
      name = "rspamd";
      ensureDBOwnership = true;
    }
  ];

  # Deploy Sieve scripts for spam/ham learning
  systemd.tmpfiles.rules = [
    "d /var/lib/dovecot/sieve/rspamd 0755 dovecot2 dovecot2 -"
    "L+ /var/lib/dovecot/sieve/rspamd/learn-spam.sieve - - - - ${learnSpamScript}"
    "L+ /var/lib/dovecot/sieve/rspamd/learn-ham.sieve - - - - ${learnHamScript}"
    "L+ /var/lib/dovecot/sieve/rspamd/move-to-isspam.sieve - - - - ${moveToIsSpamScript}"
    "L+ /var/lib/dovecot/sieve/rspamd/move-to-isgood.sieve - - - - ${moveToIsGoodScript}"
    "L+ /usr/local/bin/rspamd-learn-spam.sh - - - - ${learnSpamShellScript}"
    "L+ /usr/local/bin/rspamd-learn-ham.sh - - - - ${learnHamShellScript}"
    "d /run/rspamd 0755 rspamd rspamd -"
  ];

  # Systemd service to scan mailboxes after mbsync
  systemd.services.rspamd-scan-mailboxes = {
    description = "Scan mailboxes with Rspamd and move spam";
    after = [ "mbsync-johnw.service" "rspamd.service" ];
    wants = [ "rspamd.service" ];

    serviceConfig = {
      Type = "oneshot";
      ExecStart = "${mailboxScannerScript}";
      User = "root";  # Need root to access /var/mail directories
      Group = "root";
    };
  };

  # Timer to run mailbox scanner every 15 minutes
  systemd.timers.rspamd-scan-mailboxes = {
    description = "Timer for Rspamd mailbox scanning";
    wantedBy = [ "timers.target" ];

    timerConfig = {
      # Run 2 minutes after mbsync-johnw completes
      OnUnitActiveSec = "15min";
      OnBootSec = "5min";
      Persistent = true;
    };
  };

  # Systemd service to load Rspamd controller password into environment
  systemd.services.rspamd = {
    serviceConfig = {
      EnvironmentFile = pkgs.writeText "rspamd-env" ''
        RSPAMD_CONTROLLER_PASSWORD=$(cat ${controllerPasswordFile})
      '';
    };
  };

  # Nginx virtual host for Rspamd web UI
  services.nginx.virtualHosts."rspamd.vulcan.lan" = {
    forceSSL = true;
    sslCertificate = "/var/lib/nginx-certs/rspamd.vulcan.lan.crt";
    sslCertificateKey = "/var/lib/nginx-certs/rspamd.vulcan.lan.key";

    locations."/" = {
      proxyPass = "http://127.0.0.1:11334/";
      proxyWebsockets = true;
      extraConfig = ''
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
      '';
    };

    # Metrics endpoint for Prometheus
    locations."/metrics" = {
      proxyPass = "http://127.0.0.1:11334/metrics";
      extraConfig = ''
        # Allow Prometheus to scrape metrics
        allow 127.0.0.1;
        deny all;
      '';
    };
  };

  # Prometheus scrape configuration for Rspamd metrics
  services.prometheus.scrapeConfigs = [
    {
      job_name = "rspamd";
      static_configs = [{
        targets = [ "localhost:11334" ];
      }];
      metrics_path = "/metrics";
    }
  ];

  # Open firewall for Rspamd (if needed for milter access)
  # Note: Rspamd listens on localhost only by default
  networking.firewall.allowedTCPPorts = lib.mkIf config.services.rspamd.enable [ ];

  # System packages for Rspamd utilities
  environment.systemPackages = with pkgs; [
    rspamd
  ];
}
