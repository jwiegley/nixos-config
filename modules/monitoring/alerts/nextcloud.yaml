groups:
  - name: nextcloud
    interval: 30s
    rules:
      # Service availability
      - alert: NextcloudDown
        expr: up{job="nextcloud"} == 0
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Nextcloud is down"
          description: "Nextcloud service on {{ $labels.instance }} has been down for more than 5 minutes."

      # Storage alerts
      - alert: NextcloudStorageLow
        expr: nextcloud_system_freespace_bytes < 21474836480  # <20GB
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Nextcloud storage space low"
          description: "Nextcloud has less than 20GB of free storage space remaining."

      - alert: NextcloudStorageCritical
        expr: nextcloud_system_freespace_bytes < 10737418240  # <10GB
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Nextcloud storage space critical"
          description: "Nextcloud has less than 10GB of free storage space remaining. Immediate action required."

      # Active users monitoring
      - alert: NextcloudHighUserLoad
        expr: nextcloud_users_active > 10
        for: 15m
        labels:
          severity: info
        annotations:
          summary: "High number of active Nextcloud users"
          description: "Nextcloud has {{ $value }} active users for more than 15 minutes."

      # Database connectivity
      - alert: NextcloudDatabaseIssue
        expr: increase(nextcloud_database_size_bytes[5m]) < 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Nextcloud database may have issues"
          description: "Nextcloud database metrics show anomalous behavior."

      # App status
      - alert: NextcloudAppsDisabled
        expr: nextcloud_apps_installed - nextcloud_apps_updates_available > 0
        for: 1h
        labels:
          severity: info
        annotations:
          summary: "Nextcloud app updates available"
          description: "There are {{ $value }} Nextcloud apps with available updates."

      # PHP-FPM pool health
      - alert: NextcloudPHPFPMHighUtilization
        expr: phpfpm_active_processes / phpfpm_max_children > 0.8
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Nextcloud PHP-FPM pool nearing capacity"
          description: "PHP-FPM pool is using {{ $value | humanizePercentage }} of available processes."

      # Background jobs
      - alert: NextcloudBackgroundJobsStalled
        expr: time() - nextcloud_jobs_last_run > 600  # 10 minutes
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Nextcloud background jobs may be stalled"
          description: "Nextcloud background jobs haven't run in {{ $value | humanizeDuration }}."
